<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Invest Management | –õ–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
          crossorigin="anonymous">
    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        body {
            padding: 0;
            background: #0f172a;
            color: #e2e8f0;
            height: 100%;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        main {
            width: 100%;
            height: 100%;
            padding: 1rem 3rem 0.5rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
            flex-shrink: 0;
        }

        .table-container {
            width: 100%;
            display: flex;
            justify-content: center;
            max-height: 630px;
            overflow-y: auto;
            scrollbar-width: thin;
            flex: 1 1 auto;
        }

        table {
            width: 100%;
            min-width: 0;
            border-collapse: collapse;
            font-size: 0.5rem;
        }

        thead {
            position: sticky;
            top: 0;
            background: #ffffff;
            z-index: 10;
        }

        th, td {
            padding: 0.16rem 0.4rem;
            white-space: nowrap;
        }

        td:nth-child(3) {
            max-width: 140px;
            white-space: normal;
        }

        table input[type="number"] {
            width: 100%;
            box-sizing: border-box;
            padding: 0.2rem 0.25rem;
            font-size: 0.5rem;
        }

        .actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        select {
            width: 100%;
            padding: 0.2rem 0.25rem;
            font-size: 0.5rem;
            min-width: 90px;
        }

        .recommendation-buy {
            color: #22c55e;
        }

        .recommendation-hold {
            color: #eab308;
        }

        .recommendation-sell {
            color: #ef4444;
        }

        .recommendation-none {
            color: #94a3b8;
        }

        .alert {
            padding: 0.5rem 0.75rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            flex-shrink: 0;
        }

        .alert-success {
            background: rgba(34, 197, 94, 0.1);
            color: #4ade80;
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.12);
            color: #f87171;
        }

        dialog {
            border: none;
            padding: 0;
            background: transparent;
        }

        dialog[open] {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        dialog::backdrop {
            background: rgba(15, 23, 42, 0.75);
        }

        dialog article {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1.75rem;
            border-radius: 16px;
            max-width: 760px;
            max-height: 80vh;
            overflow: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
        }

        .muted {
            color: #c4b5fd;
        }

        .text-right {
            text-align: right;
        }

        .sort-buttons {
            display: inline-flex;
            flex-direction: column;
            gap: 0.1rem;
            margin-left: 0.25rem;
            vertical-align: middle;
        }

        .sort-button {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            cursor: pointer;
            font-size: 0.4rem;
            line-height: 0.6;
            color: #64748b;
            opacity: 0.6;
            transition: opacity 0.2s, color 0.2s;
        }

        .sort-button:hover {
            opacity: 1;
            color: #e2e8f0;
        }

        .sort-button.active {
            opacity: 1;
            color: #3b82f6;
        }

        th {
            position: relative;
            padding-right: 1.5rem !important;
        }

        th .sort-buttons {
            position: absolute;
            right: 0.25rem;
            top: 50%;
            transform: translateY(-50%);
        }

        #analysis-form {
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            min-height: 0;
        }

        .info-row {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            flex-shrink: 0;
        }
    </style>
</head>
<body th:data-open-dialog="${openAddDialog}" th:data-newly-added-secid="${newlyAddedSecid}">
<main>
    <header>
        <div>
            <h1>–õ–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h1>
            <p class="muted">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ —É—Ä–æ–≤–Ω—è–º–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∞–∫—Ü–∏—è–º.</p>
        </div>
        <div class="actions">
            <a href="/dashboard" role="button" class="secondary">‚Üê –ù–∞–∑–∞–¥ –≤ –ø–∞–Ω–µ–ª—å</a>
            <button type="button" id="refresh-button" class="secondary">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
            </button>
            <button type="button"
                    id="add-button"
                    th:disabled="${availableStocks.isEmpty()}">
                –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ü–∏—é
            </button>
        </div>
    </header>

    <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
    <div th:if="${errorMessage}" class="alert alert-error" th:text="${errorMessage}"></div>

    <form th:if="${hasRows}" th:action="@{/analysis/update}" method="post" id="analysis-form">
        <div class="table-container">
            <table role="grid">
                <thead>
                <tr>
                    <th>#</th>
                    <th>
                        –¢–∏–∫–µ—Ä
                        <div class="sort-buttons">
                            <button type="button" class="sort-button" 
                                    th:classappend="${currentSortBy == 'secid' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('secid', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'secid' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('secid', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th>
                        –ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
                        <div class="sort-buttons">
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'shortname' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('shortname', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'shortname' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('shortname', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th>
                        –°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ
                        <div class="sort-buttons">
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'support' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('support', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'support' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('support', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th>
                        –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                        <div class="sort-buttons">
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'supportUpdatedAt' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('supportUpdatedAt', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'supportUpdatedAt' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('supportUpdatedAt', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th>
                        –ü–æ–¥–¥–µ—Ä–∂–∫–∞
                        <div class="sort-buttons">
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'resistance' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('resistance', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'resistance' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('resistance', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th>
                        –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                        <div class="sort-buttons">
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'resistanceUpdatedAt' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('resistanceUpdatedAt', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'resistanceUpdatedAt' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('resistanceUpdatedAt', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th>
                        –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞
                        <div class="sort-buttons">
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'marketprice' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('marketprice', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'marketprice' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('marketprice', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th>
                        –ü–æ—Ç–µ–Ω—Ü. –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å, %
                        <div class="sort-buttons">
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'potentialgainpercent' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('potentialgainpercent', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'potentialgainpercent' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('potentialgainpercent', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th>
                        –ü–æ—Ç–µ–Ω—Ü. —É–±—ã—Ç–æ–∫, %
                        <div class="sort-buttons">
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'potentiallosspercent' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('potentiallosspercent', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'potentiallosspercent' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('potentiallosspercent', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th>
                        –û—Ü–µ–Ω–∫–∞ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤
                        <div class="sort-buttons">
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'experttarget' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('experttarget', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'experttarget' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('experttarget', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th>
                        –û–±–Ω–æ–≤–ª–µ–Ω–æ
                        <div class="sort-buttons">
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'experttargetupdatedat' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('experttargetupdatedat', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'experttargetupdatedat' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('experttargetupdatedat', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th>
                        –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
                        <div class="sort-buttons">
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'expertrecommendation' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('expertrecommendation', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'expertrecommendation' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('expertrecommendation', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th>
                        –ü—Ä–æ–≥–Ω–æ–∑ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤, %
                        <div class="sort-buttons">
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'expertforecastpercent' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('expertforecastpercent', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'expertforecastpercent' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('expertforecastpercent', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="row, iterStat : ${rows}"
                    th:attr="data-analysis-id=${row.analysis.id},data-secid=${row.analysis.stock.secid}">
                    <td th:text="${iterStat.count}">1</td>
                    <td th:text="${row.analysis.stock.secid}">TICK</td>
                    <td th:text="${row.analysis.stock.shortname}">–ù–∞–∑–≤–∞–Ω–∏–µ</td>
                    <td>
                        <input type="number"
                               th:name="'support[' + ${row.analysis.id} + ']'"
                               th:attr="data-analysis-id=${row.analysis.id},step=${row.inputStep}"
                               th:value="${row.supportDisplay}"
                               data-field="support"
                               placeholder="‚Äî">
                    </td>
                    <td th:text="${row.analysis.supportUpdatedAt != null ? #temporals.format(row.analysis.supportUpdatedAt, 'dd.MM.yyyy HH:mm') : '‚Äî'}">‚Äî</td>
                    <td>
                        <input type="number"
                               th:name="'resistance[' + ${row.analysis.id} + ']'"
                               th:attr="data-analysis-id=${row.analysis.id},step=${row.inputStep}"
                               th:value="${row.resistanceDisplay}"
                               data-field="resistance"
                               placeholder="‚Äî">
                    </td>
                    <td th:text="${row.analysis.resistanceUpdatedAt != null ? #temporals.format(row.analysis.resistanceUpdatedAt, 'dd.MM.yyyy HH:mm') : '‚Äî'}">‚Äî</td>
                    <td th:text="${row.marketPrice != null ? #numbers.formatDecimal(row.marketPrice, 1, row.priceDecimals) : '‚Äî'}"
                        class="text-right"
                        th:attr="data-price-decimals=${row.priceDecimals}">‚Äî</td>
                    <td th:text="${row.potentialGainPercent != null ? #numbers.formatDecimal(row.potentialGainPercent, 1, 2) : '‚Äî'}"
                        class="text-right">‚Äî</td>
                    <td th:text="${row.potentialLossPercent != null ? #numbers.formatDecimal(row.potentialLossPercent, 1, 2) : '‚Äî'}"
                        class="text-right">‚Äî</td>
                    <td>
                        <span class="expert-field-clickable"
                              th:attr="data-analysis-id=${row.analysis.id},data-field='expertTarget'"
                              th:text="${row.expertTargetDisplay != null && !row.expertTargetDisplay.isEmpty() ? row.expertTargetDisplay : '‚Äî'}"
                              style="cursor: pointer; text-decoration: underline; color: #3b82f6;">
                        </span>
                    </td>
                    <td th:text="${row.analysis.expertTargetUpdatedAt != null ? #temporals.format(row.analysis.expertTargetUpdatedAt, 'dd.MM.yyyy HH:mm') : '‚Äî'}">‚Äî</td>
                    <td>
                        <span class="expert-field-clickable"
                              th:attr="data-analysis-id=${row.analysis.id},data-field='expertRecommendation'"
                              th:class="${row.expertRecommendationClass}"
                              th:text="${row.expertRecommendation != null ? row.expertRecommendation : '‚Äî'}"
                              style="cursor: pointer; text-decoration: underline;">
                        </span>
                    </td>
                    <td class="text-right"
                        th:text="${row.expertForecastPercent != null ? #numbers.formatDecimal(row.expertForecastPercent, 1, 2) : '‚Äî'}">‚Äî</td>
                    <td class="text-right">
                        <button type="button"
                                class="secondary outline"
                                th:attr="data-delete-id=${row.analysis.id}"
                                onclick="submitDelete(this)">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="info-row muted">–ò–∑–º–µ–Ω–∏—Ç–µ —É—Ä–æ–≤–Ω–∏ –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ Enter.</div>
    </form>
    <p th:if="${!hasRows}" class="muted">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∞–∫—Ü–∏—é, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑.</p>
</main>

<form id="delete-form" th:action="@{/analysis/delete}" method="post" hidden>
    <input type="hidden" name="id" id="delete-id">
</form>

<dialog id="add-dialog">
    <article>
        <header>
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ü–∏—é</h2>
            <a href="#close" aria-label="–ó–∞–∫—Ä—ã—Ç—å" class="close"
               onclick="document.getElementById('add-dialog').close()"></a>
        </header>
        <form th:action="@{/analysis/add}" method="post" id="add-form">
            <table role="grid">
                <thead>
                <tr>
                    <th>#</th>
                    <th>–¢–∏–∫–µ—Ä</th>
                    <th>–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="stock, iterStat : ${availableStocks}">
                    <td th:text="${iterStat.count}">1</td>
                    <td th:text="${stock.secid}">TICK</td>
                    <td th:text="${stock.shortname}">–ù–∞–∑–≤–∞–Ω–∏–µ</td>
                    <td>
                        <label>
                            <input type="radio" name="secid"
                                   th:value="${stock.secid}"
                                   th:checked="${stock.secid == defaultSelection}">
                            <span>–í—ã–±—Ä–∞—Ç—å</span>
                        </label>
                    </td>
                </tr>
                </tbody>
            </table>
            <footer class="info-row">
                <div class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—É—é –±—É–º–∞–≥—É –∏ –Ω–∞–∂–º–∏—Ç–µ Enter. Esc –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ.</div>
                <div class="actions">
                    <button type="button" class="secondary outline"
                            onclick="document.getElementById('add-dialog').close()">–û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </footer>
        </form>
    </article>
</dialog>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ —Å –∏—Å—Ç–æ—Ä–∏–µ–π -->
<dialog id="expert-assessment-dialog">
    <article style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <header>
            <h3>–≠–∫—Å–ø–µ—Ä—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ - –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h3>
        </header>
        
        <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ -->
        <form id="expert-assessment-form" method="post" th:action="@{/analysis/expert-assessment}">
            <input type="hidden" name="analysisId" id="expert-assessment-analysis-id">
            
            <table style="width: 100%; margin-bottom: 1rem; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: rgba(255, 255, 255, 0.1);">
                        <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞</th>
                        <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</th>
                        <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–î–∞—Ç–∞ –æ—Ü–µ–Ω–∫–∏</th>
                        <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                        <th style="padding: 0.5rem; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–î–µ–π—Å—Ç–≤–∏–µ</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞) -->
                    <tr style="background-color: rgba(59, 130, 246, 0.15);">
                        <td style="padding: 0.5rem;">
                            <input type="number" 
                                   name="expertTarget" 
                                   id="expert-assessment-target"
                                   step="0.01"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É"
                                   style="width: 100%; padding: 0.4rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #e2e8f0; border-radius: 4px;">
                        </td>
                        <td style="padding: 0.5rem;">
                            <select name="expertRecommendation" id="expert-assessment-recommendation" style="width: 100%; padding: 0.4rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #e2e8f0; border-radius: 4px;">
                                <option value="">‚Äî</option>
                                <option value="–ü–æ–∫—É–ø–∞—Ç—å">–ü–æ–∫—É–ø–∞—Ç—å</option>
                                <option value="–î–µ—Ä–∂–∞—Ç—å">–î–µ—Ä–∂–∞—Ç—å</option>
                                <option value="–ü—Ä–æ–¥–∞–≤–∞—Ç—å">–ü—Ä–æ–¥–∞–≤–∞—Ç—å</option>
                            </select>
                        </td>
                        <td style="padding: 0.5rem;">
                            <input type="date" 
                                   name="expertTargetDate" 
                                   id="expert-assessment-date"
                                   required
                                   style="width: 100%; padding: 0.4rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #e2e8f0; border-radius: 4px;">
                        </td>
                        <td style="padding: 0.5rem; color: #94a3b8; font-size: 0.9em;">
                            <em>–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</em>
                        </td>
                        <td style="padding: 0.5rem; text-align: center;">
                            <button type="submit" style="padding: 0.4rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">–î–æ–±–∞–≤–∏—Ç—å</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <!-- –ò—Å—Ç–æ—Ä–∏—è (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript) -->
            <div style="margin-top: 1rem;">
                <h4 style="margin-bottom: 0.5rem;">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: rgba(255, 255, 255, 0.05);">
                            <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞</th>
                            <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</th>
                            <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–î–∞—Ç–∞ –æ—Ü–µ–Ω–∫–∏</th>
                            <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="expert-assessment-history">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 1rem; color: #94a3b8;">
                                –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            </table>
            
            <footer class="info-row">
                <div class="muted">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –∏ –Ω–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏</div>
                <div class="actions">
                    <button type="button" class="secondary outline" onclick="closeExpertAssessmentDialog()">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </footer>
        </form>
    </article>
</dialog>

<script>
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ (–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ)
    function openExpertAssessmentDialog(analysisId, field, currentValue) {
        console.log('openExpertAssessmentDialog –≤—ã–∑–≤–∞–Ω–∞:', { analysisId, field, currentValue });
        const dialog = document.getElementById('expert-assessment-dialog');
        const form = document.getElementById('expert-assessment-form');
        const analysisIdInput = document.getElementById('expert-assessment-analysis-id');
        const targetInput = document.getElementById('expert-assessment-target');
        const recommendationSelect = document.getElementById('expert-assessment-recommendation');
        const dateInput = document.getElementById('expert-assessment-date');
        const historyTbody = document.getElementById('expert-assessment-history');
        
        if (!dialog) {
            console.error('–î–∏–∞–ª–æ–≥ expert-assessment-dialog –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        if (!form || !analysisIdInput) {
            console.error('–≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            return;
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID –∞–Ω–∞–ª–∏–∑–∞
        analysisIdInput.value = analysisId;
        
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        if (targetInput) targetInput.value = '';
        if (recommendationSelect) recommendationSelect.value = '';
        if (dateInput) {
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        if (historyTbody) {
            loadExpertAssessmentHistory(analysisId, historyTbody);
        }
        
        // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –Ω—É–∂–Ω–æ–º –ø–æ–ª–µ
        setTimeout(() => {
            if (field === 'expertTarget' && targetInput) {
                targetInput.focus();
            } else if (field === 'expertRecommendation' && recommendationSelect) {
                recommendationSelect.focus();
            }
        }, 100);
        
        dialog.showModal();
        console.log('–î–∏–∞–ª–æ–≥ –æ—Ç–∫—Ä—ã—Ç');
    }

    async function loadExpertAssessmentHistory(analysisId, tbody) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 1rem; color: #94a3b8;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
        
        try {
            const response = await fetch(`/analysis/expert-assessment/${analysisId}/history`);
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ' + response.status);
            }
            const history = await response.json();
            
            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 1rem; color: #94a3b8;">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</td></tr>';
                return;
            }
            
            tbody.innerHTML = history.map(item => {
                const createdAt = item.createdAt ? new Date(item.createdAt).toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '‚Äî';
                const targetDate = item.expertTargetDate ? new Date(item.expertTargetDate + 'T00:00:00').toLocaleDateString('ru-RU') : '‚Äî';
                const recommendationClass = item.expertRecommendation === '–ü–æ–∫—É–ø–∞—Ç—å' ? 'recommendation-buy' :
                                          item.expertRecommendation === '–î–µ—Ä–∂–∞—Ç—å' ? 'recommendation-hold' :
                                          item.expertRecommendation === '–ü—Ä–æ–¥–∞–≤–∞—Ç—å' ? 'recommendation-sell' : '';
                const targetValue = item.expertTarget ? parseFloat(item.expertTarget).toLocaleString('ru-RU', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 6
                }) : '‚Äî';
                
                return `
                    <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                        <td style="padding: 0.5rem;">${targetValue}</td>
                        <td style="padding: 0.5rem;" class="${recommendationClass}">${item.expertRecommendation || '‚Äî'}</td>
                        <td style="padding: 0.5rem;">${targetDate}</td>
                        <td style="padding: 0.5rem; color: #94a3b8; font-size: 0.9em;">${createdAt}</td>
                    </tr>
                `;
            }).join('');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 1rem; color: #ef4444;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ' + error.message + '</td></tr>';
        }
    }

    function closeExpertAssessmentDialog() {
        const dialog = document.getElementById('expert-assessment-dialog');
        if (dialog) {
            dialog.close();
        }
    }

    (function () {
        const supportInputs = document.querySelectorAll('input[data-field="support"]');
        const resistanceInputs = document.querySelectorAll('input[data-field="resistance"]');
        const expertFieldClickables = document.querySelectorAll('.expert-field-clickable');
        const analysisForm = document.getElementById('analysis-form');
        const addForm = document.getElementById('add-form');
        const dialog = document.getElementById('add-dialog');
        const addButton = document.getElementById('add-button');
        const shouldOpenDialog = document.body.dataset.openDialog === 'true';
        const newlyAddedSecid = document.body.dataset.newlyAddedSecid;

        if (addButton && dialog) {
            addButton.addEventListener('click', () => {
                console.debug('Opening add-dialog. options=%d', dialog.querySelectorAll('tbody tr').length);
                dialog.showModal();
            });
        }

        if (dialog) {
            if (shouldOpenDialog && !dialog.open) {
                console.debug('Auto-opening add-dialog');
                dialog.showModal();
            }
            dialog.addEventListener('close', () => console.debug('Add-dialog closed'));
            dialog.addEventListener('cancel', () => console.debug('Add-dialog cancelled'));
        }

        supportInputs.forEach(input => {
            input.addEventListener('keydown', event => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const id = input.dataset.analysisId;
                    saveScrollPosition();
                    queueFocus({field: 'resistance', id: id});
                    submitAnalysisForm(analysisForm);
                }
            });
            input.addEventListener('focus', () => {
                queueFocus({field: 'support', id: input.dataset.analysisId});
            });
        });

        resistanceInputs.forEach(input => {
            input.addEventListener('keydown', event => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    saveScrollPosition();
                    queueFocus({field: 'expertTarget', id: input.dataset.analysisId});
                    submitAnalysisForm(analysisForm);
                }
            });
            input.addEventListener('focus', () => {
                queueFocus({field: 'resistance', id: input.dataset.analysisId});
            });
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –Ω–∞ –ø–æ–ª—è —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫–∏
        console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã—Ö –ø–æ–ª–µ–π. –ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤:', expertFieldClickables.length);
        if (expertFieldClickables.length === 0) {
            console.warn('–ù–µ –Ω–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å –∫–ª–∞—Å—Å–æ–º expert-field-clickable. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ HTML —Ä–∞–∑–º–µ—Ç–∫—É.');
        }
        expertFieldClickables.forEach((element, index) => {
            console.log(`–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞ ${index}:`, {
                analysisId: element.dataset.analysisId,
                field: element.dataset.field,
                text: element.textContent.trim(),
                element: element
            });
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –∫–ª–∏–∫–∞–±–µ–ª–µ–Ω
            element.style.cursor = 'pointer';
            element.style.textDecoration = 'underline';
            if (!element.style.color || element.style.color === '') {
                element.style.color = '#3b82f6';
            }
            
            element.addEventListener('click', (event) => {
                event.preventDefault();
                event.stopPropagation();
                const analysisId = element.dataset.analysisId;
                const field = element.dataset.field;
                const currentValue = element.textContent.trim();
                console.log('–ö–ª–∏–∫ –Ω–∞ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–µ –ø–æ–ª–µ:', { analysisId, field, currentValue });
                if (typeof openExpertAssessmentDialog === 'function') {
                    openExpertAssessmentDialog(analysisId, field, currentValue);
                } else {
                    console.error('–§—É–Ω–∫—Ü–∏—è openExpertAssessmentDialog –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞!');
                    alert('–û—à–∏–±–∫–∞: —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–∏–∞–ª–æ–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.');
                }
            });
        });

        if (analysisForm) {
            analysisForm.addEventListener('submit', () => {
                analysisForm.dataset.submitting = 'true';
            });
        }

        if (addForm) {
            const radioInputs = addForm.querySelectorAll('input[name="secid"]');
            radioInputs.forEach(input => {
                input.addEventListener('keydown', event => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        addForm.requestSubmit();
                    }
                });
                input.addEventListener('dblclick', () => addForm.requestSubmit());
            });
        }

        const tableContainer = document.querySelector('.table-container');

        if (tableContainer) {
            tableContainer.addEventListener('wheel', event => {
                const {scrollTop, scrollHeight, clientHeight} = tableContainer;
                const atTop = scrollTop === 0 && event.deltaY < 0;
                const atBottom = Math.ceil(scrollTop + clientHeight) >= scrollHeight && event.deltaY > 0;
                if (!(atTop || atBottom)) {
                    event.preventDefault();
                    tableContainer.scrollTop += event.deltaY;
                }
            }, {passive: false});
        }

        // –ï—Å–ª–∏ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∞–∫—Ü–∏—è, –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–µ–π –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å
        if (newlyAddedSecid) {
            setTimeout(() => {
                const row = document.querySelector('tr[data-secid="' + newlyAddedSecid + '"]');
                if (row) {
                    const supportInput = row.querySelector('input[data-field="support"]');
                    if (supportInput) {
                        scrollIntoViewIfNeeded(supportInput);
                        supportInput.focus();
                        supportInput.select();
                    }
                }
            }, 100);
        } else {
            restoreScrollPosition();
            restoreFocus();
        }
        console.debug('analysis page init: rows=%d, addButton=%s, shouldOpenDialog=%s, newlyAddedSecid=%s',
            document.querySelectorAll('tr[data-analysis-id]').length,
            !!addButton,
            shouldOpenDialog,
            newlyAddedSecid || 'none');

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        const refreshButton = document.getElementById('refresh-button');
        if (refreshButton) {
            refreshButton.addEventListener('click', refreshTable);
        }
    })();

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–ª–∞
    function formatDecimal(value, decimals) {
        if (!value) return '‚Äî';
        const num = parseFloat(value);
        if (isNaN(num)) return '‚Äî';
        return num.toFixed(decimals);
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —á–µ—Ä–µ–∑ AJAX
    function refreshTable() {
        const refreshButton = document.getElementById('refresh-button');
        if (refreshButton) {
            refreshButton.disabled = true;
            refreshButton.textContent = '‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∏ —Ñ–æ–∫—É—Å
        const tableContainer = document.querySelector('.table-container');
        const scrollTop = tableContainer ? tableContainer.scrollTop : 0;
        const activeElement = document.activeElement;
        let activeField = null;
        let activeId = null;
        
        if (activeElement && activeElement.tagName === 'INPUT') {
            activeField = activeElement.dataset.field;
            activeId = activeElement.dataset.analysisId;
        } else if (activeElement && activeElement.tagName === 'SELECT') {
            activeField = 'recommendation';
            const name = activeElement.name;
            const match = name.match(/expertRecommendation\[(\d+)\]/);
            if (match) {
                activeId = match[1];
            }
        }
        
        fetch('/analysis/api/rows')
            .then(response => {
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö');
                }
                return response.json();
            })
            .then(data => {
                const tbody = document.querySelector('#analysis-form tbody');
                if (!tbody || !data.rows) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
                data.rows.forEach((rowData) => {
                    const row = tbody.querySelector(`tr[data-analysis-id="${rowData.analysisId}"]`);
                    if (!row) return;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 14) {
                        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ –¥–ª—è —Ü–µ–Ω—ã
                        const priceDecimals = rowData.priceDecimals != null ? parseInt(rowData.priceDecimals, 10) : 2;
                        
                        // –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ (–∏–Ω–¥–µ–∫—Å 7)
                        cells[7].textContent = rowData.marketPrice ? formatDecimal(rowData.marketPrice, priceDecimals) : '‚Äî';
                        // –û–±–Ω–æ–≤–ª—è–µ–º data-–∞—Ç—Ä–∏–±—É—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ decimals
                        cells[7].setAttribute('data-price-decimals', priceDecimals);
                        
                        // –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å (–∏–Ω–¥–µ–∫—Å 8)
                        cells[8].textContent = rowData.potentialGainPercent ? formatDecimal(rowData.potentialGainPercent, 2) : '‚Äî';
                        
                        // –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —É–±—ã—Ç–æ–∫ (–∏–Ω–¥–µ–∫—Å 9)
                        cells[9].textContent = rowData.potentialLossPercent ? formatDecimal(rowData.potentialLossPercent, 2) : '‚Äî';
                        
                        // –ü—Ä–æ–≥–Ω–æ–∑ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ (–∏–Ω–¥–µ–∫—Å 13)
                        cells[13].textContent = rowData.expertForecastPercent ? formatDecimal(rowData.expertForecastPercent, 2) : '‚Äî';
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Å–ø–µ—Ä—Ç–Ω—É—é –æ—Ü–µ–Ω–∫—É (–∏–Ω–¥–µ–∫—Å 10 - "–û—Ü–µ–Ω–∫–∞ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤")
                        if (cells.length > 10) {
                            const expertTargetSpan = cells[10].querySelector('.expert-field-clickable');
                            if (expertTargetSpan) {
                                expertTargetSpan.textContent = rowData.expertTarget && rowData.expertTarget !== '‚Äî' ? rowData.expertTarget : '‚Äî';
                            }
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ (–∏–Ω–¥–µ–∫—Å 11)
                        if (cells.length > 11 && rowData.expertTargetUpdatedAt) {
                            const date = new Date(rowData.expertTargetUpdatedAt);
                            cells[11].textContent = date.toLocaleString('ru-RU', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é (–∏–Ω–¥–µ–∫—Å 12)
                        if (cells.length > 12) {
                            const recommendationSpan = cells[12].querySelector('.expert-field-clickable');
                            if (recommendationSpan) {
                                recommendationSpan.textContent = rowData.expertRecommendation || '‚Äî';
                                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Ü–≤–µ—Ç–∞
                                recommendationSpan.className = 'expert-field-clickable';
                                if (rowData.expertRecommendation === '–ü–æ–∫—É–ø–∞—Ç—å') {
                                    recommendationSpan.classList.add('recommendation-buy');
                                } else if (rowData.expertRecommendation === '–î–µ—Ä–∂–∞—Ç—å') {
                                    recommendationSpan.classList.add('recommendation-hold');
                                } else if (rowData.expertRecommendation === '–ü—Ä–æ–¥–∞–≤–∞—Ç—å') {
                                    recommendationSpan.classList.add('recommendation-sell');
                                }
                            }
                        }
                    }
                });
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                if (tableContainer) {
                    tableContainer.scrollTop = scrollTop;
                }
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å
                if (activeField && activeId) {
                    setTimeout(() => {
                        let element = null;
                        if (activeField === 'support') {
                            element = document.querySelector(`input[data-field="support"][data-analysis-id="${activeId}"]`);
                        } else if (activeField === 'resistance') {
                            element = document.querySelector(`input[data-field="resistance"][data-analysis-id="${activeId}"]`);
                        } else if (activeField === 'expertTarget') {
                            element = document.querySelector(`input[data-field="expertTarget"][data-analysis-id="${activeId}"]`);
                        } else if (activeField === 'recommendation') {
                            element = document.querySelector(`select[name="expertRecommendation[${activeId}]"]`);
                        }
                        
                        if (element) {
                            scrollIntoViewIfNeeded(element);
                            element.focus();
                            if (element.tagName === 'INPUT') {
                                element.select();
                            }
                        }
                    }, 50);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            })
            .finally(() => {
                if (refreshButton) {
                    refreshButton.disabled = false;
                    refreshButton.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å';
                }
            });
    }

    function submitDelete(button) {
        const id = button.getAttribute('data-delete-id');
        const deleteForm = document.getElementById('delete-form');
        const input = document.getElementById('delete-id');
        input.value = id;
        deleteForm.submit();
    }

    function submitAnalysisForm(form) {
        if (!form || form.dataset.submitting === 'true') {
            return;
        }
        form.dataset.submitting = 'true';
        form.requestSubmit();
    }


    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫–∏
    (function() {
        const expertAssessmentForm = document.getElementById('expert-assessment-form');
        if (expertAssessmentForm) {
            expertAssessmentForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                
                const formData = new FormData(expertAssessmentForm);
                const submitButton = expertAssessmentForm.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                submitButton.disabled = true;
                submitButton.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                
                try {
                    const response = await fetch(expertAssessmentForm.action, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏ –æ—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                        const analysisId = document.getElementById('expert-assessment-analysis-id').value;
                        const historyTbody = document.getElementById('expert-assessment-history');
                        if (historyTbody) {
                            await loadExpertAssessmentHistory(analysisId, historyTbody);
                        }
                        
                        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                        const form = document.getElementById('expert-assessment-form');
                        if (form) {
                            form.reset();
                            const dateInput = document.getElementById('expert-assessment-date');
                            if (dateInput) {
                                const today = new Date().toISOString().split('T')[0];
                                dateInput.value = today;
                            }
                            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º analysisId –ø–æ—Å–ª–µ reset
                            document.getElementById('expert-assessment-analysis-id').value = analysisId;
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —ç–∫—Å–ø–µ—Ä—Ç–Ω—É—é –æ—Ü–µ–Ω–∫—É)
                        refreshTable();
                        
                        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + (result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫—É'));
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫–∏:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message);
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            });
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –¥–∏–∞–ª–æ–≥–∞ –ø–æ Escape
        const expertDialog = document.getElementById('expert-assessment-dialog');
        if (expertDialog) {
            expertDialog.addEventListener('cancel', function(event) {
                event.preventDefault();
                closeExpertAssessmentDialog();
            });
        }
    })();

    function queueFocus(target) {
        try {
            sessionStorage.setItem('analysisFocus', JSON.stringify(target));
        } catch (err) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ–∫—É—Å', err);
        }
    }

    function saveScrollPosition() {
        const tableContainer = document.querySelector('.table-container');
        if (tableContainer) {
            try {
                sessionStorage.setItem('analysisScrollTop', String(tableContainer.scrollTop));
            } catch (err) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏', err);
            }
        }
    }

    function restoreScrollPosition() {
        const tableContainer = document.querySelector('.table-container');
        if (!tableContainer) {
            return;
        }
        try {
            const stored = sessionStorage.getItem('analysisScrollTop');
            if (stored) {
                sessionStorage.removeItem('analysisScrollTop');
                const scrollTop = parseInt(stored, 10);
                if (!isNaN(scrollTop)) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
                    requestAnimationFrame(() => {
                        tableContainer.scrollTop = scrollTop;
                    });
                }
            }
        } catch (err) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏', err);
        }
    }

    function scrollIntoViewIfNeeded(element) {
        if (!element) {
            return;
        }
        const tableContainer = document.querySelector('.table-container');
        if (!tableContainer) {
            return;
        }
        const containerRect = tableContainer.getBoundingClientRect();
        const elementRect = element.getBoundingClientRect();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∏–¥–µ–Ω –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
        const isVisible = elementRect.top >= containerRect.top && 
                         elementRect.bottom <= containerRect.bottom;
        
        if (!isVisible) {
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã —ç–ª–µ–º–µ–Ω—Ç –±—ã–ª –≤ —Ü–µ–Ω—Ç—Ä–µ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
            const row = element.closest('tr');
            if (row) {
                const rowOffset = row.offsetTop;
                const containerHeight = tableContainer.clientHeight;
                const rowHeight = row.offsetHeight;
                tableContainer.scrollTop = rowOffset - (containerHeight / 2) + (rowHeight / 2);
            }
        }
    }

    function sortTable(sortBy, sortDir) {
        const url = new URL(window.location.href);
        url.searchParams.set('sortBy', sortBy);
        url.searchParams.set('sortDir', sortDir);
        window.location.href = url.toString();
    }

    function restoreFocus() {
        const stored = sessionStorage.getItem('analysisFocus');
        if (!stored) {
            return;
        }
        sessionStorage.removeItem('analysisFocus');
        try {
            const target = JSON.parse(stored);
            if (!target || !target.field) {
                return;
            }
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏, —á—Ç–æ–±—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —É—Å–ø–µ–ª–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
            setTimeout(() => {
                if (target.field === 'addButton') {
                    const addButton = document.getElementById('add-button');
                    if (addButton) {
                        addButton.focus();
                    }
                    return;
                }
                if (target.field === 'recommendation' && target.id) {
                    const select = document.querySelector('select[name="expertRecommendation[' + target.id + ']"]');
                    if (select) {
                        scrollIntoViewIfNeeded(select);
                        select.focus();
                    }
                    return;
                }
                if (target.field === 'support' && target.secid) {
                    const row = document.querySelector('tr[data-secid="' + target.secid + '"] input[data-field="support"]');
                    if (row) {
                        scrollIntoViewIfNeeded(row);
                        row.focus();
                        row.select();
                    }
                    return;
                }
                if (target.field === 'resistance' && target.id) {
                    const input = document.querySelector('input[data-field="resistance"][data-analysis-id="' + target.id + '"]');
                    if (input) {
                        scrollIntoViewIfNeeded(input);
                        input.focus();
                        input.select();
                    }
                    return;
                }
                if (target.field === 'expertTarget' && target.id) {
                    const input = document.querySelector('input[data-field="expertTarget"][data-analysis-id="' + target.id + '"]');
                    if (input) {
                        scrollIntoViewIfNeeded(input);
                        input.focus();
                        input.select();
                    }
                }
            }, 50);
        } catch (err) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–æ–∫—É—Å', err);
        }
    }
</script>
</body>
</html>


