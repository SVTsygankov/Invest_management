# Invest Management

Инвестиционное приложение на Spring Boot для отслеживания акций Мосбиржи и анализа уровней поддержки/сопротивления.

## Быстрый старт

1. **Поднять PostgreSQL в Docker**  
   Проверьте `docker-compose.yml`, при необходимости скорректируйте логин/пароль и путь к данным, затем запустите:
   ```bash
   docker compose up -d
   ```

2. **Запустить приложение**  
   ```bash
   ./mvnw spring-boot:run
   ```
   Приложение будет доступно по адресу http://localhost:8080/ и автоматически применит Liquibase-миграции.

3. **Создать администратора (вручную, временно)**  
   После регистрации пользователя обновите его роль через SQL:
   ```sql
   UPDATE users SET role = 'ADMIN' WHERE email = 'your-admin@mail.com';
   ```
   Войдите с этим аккаунтом и получите доступ к `/admin`.

## Текущие возможности

- Стартовая страница регистрации (`/`) с валидацией формы на стороне сервера (e-mail, пароль, подтверждение пароля).
- Сервис регистрации сохраняет пользователей в таблицу `users`, шифруя пароль через BCrypt, проверяя уникальность e-mail и подключая вход через кастомный `UserDetailsService`.
- Liquibase миграции для:
  - `users` — учетные записи с ролями.
  - `moex_stocks` — денормализованный снимок ключевых полей из ISS MOEX (SECID, режим торгов, лот, цены, капитализация, эмитент и др.).
  - `stock_analysis` — табличка для пользовательских уровней поддержки/сопротивления.
  - `portfolios`, `broker_reports`, `portfolio_positions`, `portfolio_transactions`, `portfolio_cash_movements` — управление портфелями и брокерскими отчетами.
  - `alor_user_tokens` — безопасное хранение зашифрованных токенов ALOR API.
- Пользовательская панель (`/dashboard`) и админ-панель (`/admin`, роль `ADMIN`) с возможностью загрузить/обновить акции списка A (board `TQBR`) напрямую из ISS API.
- Раздел «Личный анализ» (`/analysis`) с таблицей уровней поддержки/сопротивления, расчётом потенциальной доходности/убытка и формой выбора бумаг из справочника `moex_stocks`.
- Управление портфелями (`/portfolios`) с возможностью загрузки брокерских отчетов и отслеживания позиций.
- Автоматическое обновление рыночных цен (`marketprice`) через Spring `@Scheduled` задачу. Настраивается через `application.properties` (по умолчанию каждые 5 минут).
- **Интеграция с ALOR БРОКЕР API** — поддержка загрузки данных через ALOR OpenAPI (в разработке).

## Структура проекта

- `docker-compose.yml` — контейнер с PostgreSQL (`invest_management`).
- `src/main/resources/db/changelog` — Liquibase скрипты.
- `src/main/resources/templates/registration.html` — базовая страница регистрации (Thymeleaf + PicoCSS).
- `src/main/java/com/invest/management/web` — контроллер и форма регистрации.

## Настройка автоматического обновления цен

Автоматическое обновление рыночных цен акций настраивается в `application.properties`:

```properties
# Включить/выключить обновление цен
moex.price-updater.enabled=true

# Расписание в формате cron (секунда минута час день месяц день_недели)
moex.price-updater.cron=0 */5 * * * *  # каждые 5 минут
```

Примеры расписаний:
- `0 */5 * * * *` — каждые 5 минут
- `0 0 * * * *` — каждый час
- `0 0 9-18 * * MON-FRI` — каждый час с 9 до 18 в рабочие дни
- `0 0 10,14,16 * * MON-FRI` — в 10:00, 14:00 и 16:00 в рабочие дни

Задача обновляет только поле `marketprice` для существующих акций, не затрагивая остальные данные.

## Интеграция с ALOR БРОКЕР API

Система поддерживает интеграцию с ALOR OpenAPI для автоматической загрузки данных о сделках, позициях и движениях денежных средств.

### Настройка

1. **Получение токенов:**
   - Зарегистрируйтесь на [alor.dev](https://alor.dev)
   - Получите Refresh Token для тестового или боевого контура
   - Привяжите реальный торговый аккаунт для доступа к боевому контуру

2. **Настройка шифрования токенов:**
   
   Для безопасного хранения токенов в БД необходимо настроить шифрование в `application.properties`:
   
   ```properties
   # Генерация безопасных ключей (выполните в терминале):
   # openssl rand -base64 32  (для password)
   # openssl rand -base64 16  (для salt)
   
   alor.api.encryption.password=${ALOR_ENCRYPTION_PASSWORD}
   alor.api.encryption.salt=${ALOR_ENCRYPTION_SALT}
   ```
   
   **ВАЖНО:** Не храните пароль и соль в открытом виде в репозитории! Используйте переменные окружения или секреты.

3. **Конфигурация API:**
   
   ```properties
   # URL для тестового и боевого контуров
   alor.api.test-base-url=https://apidev.alor.ru
   alor.api.production-base-url=https://api.alor.ru
   ```

### Безопасность

- Refresh Tokens хранятся в БД в зашифрованном виде (AES256)
- Каждый пользователь имеет отдельный токен для тестового и боевого контуров
- Администраторы могут использовать оба контура для тестирования
- Обычные пользователи работают только с боевым контуром

### Структура пакетов

```
src/main/java/com/invest/management/alor/
├── common/
│   ├── AlorApiClient.java      # Клиент для работы с ALOR OpenAPI
│   └── AlorTokenService.java   # Управление токенами (шифрование/расшифровка)
├── dto/
│   ├── AlorTransaction.java    # DTO для сделок
│   ├── AlorPosition.java       # DTO для позиций
│   └── AlorCashMovement.java   # DTO для движений денежных средств
├── AlorConfig.java             # Конфигурация RestTemplate
├── AlorUserToken.java          # Entity для хранения токенов
└── AlorUserTokenRepository.java
```

## Планируемые доработки

- Завершение интеграции с ALOR OpenAPI (уточнение endpoints, маппинг данных)
- Автоматическая синхронизация данных из ALOR API
- Расширение функционала личного кабинета и инструментов аналитики по акциям

---

Запросы, идеи и задачи лучше фиксировать в issue-трекере или TODO, чтобы вести развитие проекта последовательно.

