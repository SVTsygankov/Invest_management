<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Invest Management | –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ: Stock Analysis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
          crossorigin="anonymous">
    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        body {
            padding: 0;
            background: #0f172a;
            color: #e2e8f0;
            height: 100%;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        main {
            width: 100%;
            height: 100%;
            padding: 1rem 3rem 0.5rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
            flex-shrink: 0;
        }

        .table-container {
            width: 100%;
            display: flex;
            justify-content: center;
            max-height: 630px;
            overflow-y: auto;
            scrollbar-width: thin;
            flex: 1 1 auto;
        }

        table {
            width: 100%;
            min-width: 0;
            border-collapse: collapse;
            font-size: 0.5rem;
        }

        thead {
            position: sticky;
            top: 0;
            background: #ffffff;
            z-index: 10;
        }

        th, td {
            padding: 0.16rem 0.4rem;
            white-space: nowrap;
        }

        td:nth-child(3) {
            max-width: 140px;
            white-space: normal;
        }

        table input[type="number"] {
            width: 100%;
            box-sizing: border-box;
            padding: 0.2rem 0.25rem;
            font-size: 0.5rem;
        }

        .actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        select {
            width: 100%;
            padding: 0.2rem 0.25rem;
            font-size: 0.5rem;
            min-width: 90px;
        }

        .recommendation-buy {
            color: #22c55e;
        }

        .recommendation-hold {
            color: #eab308;
        }

        .recommendation-sell {
            color: #ef4444;
        }

        .recommendation-none {
            color: #94a3b8;
        }

        .alert {
            padding: 0.5rem 0.75rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            flex-shrink: 0;
        }

        .alert-success {
            background: rgba(34, 197, 94, 0.1);
            color: #4ade80;
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.12);
            color: #f87171;
        }

        dialog {
            border: none;
            padding: 0;
            background: transparent;
        }

        dialog[open] {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        dialog::backdrop {
            background: rgba(15, 23, 42, 0.75);
        }

        dialog article {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1.75rem;
            border-radius: 16px;
            max-width: 760px;
            max-height: 80vh;
            overflow: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
        }

        .muted {
            color: #c4b5fd;
        }

        .text-right {
            text-align: right;
        }

        .sort-buttons {
            display: inline-flex;
            flex-direction: column;
            gap: 0.1rem;
            margin-left: 0.25rem;
            vertical-align: middle;
        }

        .sort-button {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            cursor: pointer;
            font-size: 0.4rem;
            line-height: 0.6;
            color: #64748b;
            opacity: 0.6;
            transition: opacity 0.2s, color 0.2s;
        }

        .sort-button:hover {
            opacity: 1;
            color: #e2e8f0;
        }

        .sort-button.active {
            opacity: 1;
            color: #3b82f6;
        }

        th {
            position: relative;
            padding-right: 1.5rem !important;
        }

        th .sort-buttons {
            position: absolute;
            right: 0.25rem;
            top: 50%;
            transform: translateY(-50%);
        }

        #analysis-form {
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            min-height: 0;
        }

        .info-row {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            flex-shrink: 0;
        }
    </style>
</head>
<body th:data-open-dialog="${openAddDialog}" th:data-newly-added-secid="${newlyAddedSecid}">
<main>
    <header>
        <div>
            <h1>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ: Stock Analysis</h1>
            <p class="muted">–ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∞–Ω–∞–ª–∏–∑–∞ –∞–∫—Ü–∏–π. –£–ø—Ä–∞–≤–ª—è–π—Ç–µ —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–º–∏ –æ—Ü–µ–Ω–∫–∞–º–∏.</p>
            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                <a href="/admin/analysis" 
                   role="button" 
                   th:style="${currentTable == 'stock_analysis' ? 'background: #3b82f6; color: white; padding: 0.4rem 0.8rem; border-radius: 8px; text-decoration: none; font-size: 0.9rem;' : 'background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 0.4rem 0.8rem; border-radius: 8px; text-decoration: none; font-size: 0.9rem;'}">
                    Stock Analysis
                </a>
                <a href="/admin/user-analysis" 
                   role="button" 
                   th:style="${currentTable == 'user_analysis' ? 'background: #3b82f6; color: white; padding: 0.4rem 0.8rem; border-radius: 8px; text-decoration: none; font-size: 0.9rem;' : 'background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 0.4rem 0.8rem; border-radius: 8px; text-decoration: none; font-size: 0.9rem;'}">
                    User Analysis
                </a>
            </div>
        </div>
        <div class="actions">
            <a href="/admin" role="button" class="secondary">‚Üê –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
            <button type="button" id="refresh-button" class="secondary">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
            </button>
            <button type="button"
                    id="add-button"
                    th:disabled="${availableStocks == null || availableStocks.isEmpty()}">
                –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ü–∏—é
            </button>
        </div>
    </header>

    <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
    <div th:if="${errorMessage}" class="alert alert-error" th:text="${errorMessage}"></div>

    <div th:if="${hasRows}" id="analysis-table">
        <div class="table-container">
            <table role="grid">
                <thead>
                <tr>
                    <th>#</th>
                    <th>
                        –¢–∏–∫–µ—Ä
                        <div class="sort-buttons">
                            <button type="button" class="sort-button" 
                                    th:classappend="${currentSortBy == 'secid' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('secid', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'secid' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('secid', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th>
                        –ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
                        <div class="sort-buttons">
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'shortname' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('shortname', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'shortname' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('shortname', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th>
                        –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞
                        <div class="sort-buttons">
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'marketprice' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('marketprice', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'marketprice' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('marketprice', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th>
                        –û—Ü–µ–Ω–∫–∞ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤
                        <div class="sort-buttons">
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'experttarget' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('experttarget', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'experttarget' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('experttarget', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th>
                        –û–±–Ω–æ–≤–ª–µ–Ω–æ
                        <div class="sort-buttons">
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'experttargetupdatedat' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('experttargetupdatedat', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'experttargetupdatedat' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('experttargetupdatedat', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th>
                        –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
                        <div class="sort-buttons">
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'expertrecommendation' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('expertrecommendation', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'expertrecommendation' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('expertrecommendation', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th>
                        –ü—Ä–æ–≥–Ω–æ–∑ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤, %
                        <div class="sort-buttons">
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'expertforecastpercent' && currentSortDir != 'desc' ? 'active' : ''}"
                                    onclick="sortTable('expertforecastpercent', 'asc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">‚ñ≤</button>
                            <button type="button" class="sort-button"
                                    th:classappend="${currentSortBy == 'expertforecastpercent' && currentSortDir == 'desc' ? 'active' : ''}"
                                    onclick="sortTable('expertforecastpercent', 'desc')" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é">‚ñº</button>
                        </div>
                    </th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="row, iterStat : ${rows}"
                    th:attr="data-analysis-id=${row.analysis.id},data-secid=${row.analysis.stock.secid}">
                    <td th:text="${iterStat.count}">1</td>
                    <td th:text="${row.analysis.stock.secid}">TICK</td>
                    <td th:text="${row.analysis.stock.shortname}">–ù–∞–∑–≤–∞–Ω–∏–µ</td>
                    <td th:text="${row.marketPrice != null ? #numbers.formatDecimal(row.marketPrice, 1, row.priceDecimals) : '‚Äî'}"
                        class="text-right"
                        th:attr="data-price-decimals=${row.priceDecimals}">‚Äî</td>
                    <td>
                        <span class="expert-field-clickable"
                              th:attr="data-analysis-id=${row.analysis.id},data-field='expertTarget',data-price-decimals=${row.priceDecimals}"
                              th:text="${row.expertTargetDisplay != null && !row.expertTargetDisplay.isEmpty() ? row.expertTargetDisplay : '‚Äî'}"
                              style="cursor: pointer; text-decoration: underline; color: #3b82f6;">
                        </span>
                    </td>
                    <td th:text="${row.analysis.expertTargetDate != null ? #temporals.format(row.analysis.expertTargetDate, 'dd.MM.yyyy') : '‚Äî'}">‚Äî</td>
                    <td>
                        <span class="expert-field-clickable"
                              th:attr="data-analysis-id=${row.analysis.id},data-field='expertRecommendation'"
                              th:class="${row.expertRecommendationClass}"
                              th:text="${row.expertRecommendation != null ? row.expertRecommendation : '‚Äî'}"
                              style="cursor: pointer; text-decoration: underline;">
                        </span>
                    </td>
                    <td class="text-right"
                        th:text="${row.expertForecastPercent != null ? #numbers.formatDecimal(row.expertForecastPercent, 1, 2) : '‚Äî'}">‚Äî</td>
                    <td class="text-right">
                        <button type="button"
                                class="secondary outline"
                                th:attr="data-delete-id=${row.analysis.id}"
                                onclick="submitDelete(this)">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

    </div>
    <p th:if="${!hasRows}" class="muted">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∞–∫—Ü–∏—é, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑.</p>
</main>

<form id="delete-form" th:action="@{/admin/analysis/delete}" method="post" hidden>
    <input type="hidden" name="id" id="delete-id">
</form>

<dialog id="add-dialog">
    <article>
        <header>
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ü–∏—é</h2>
            <a href="#close" aria-label="–ó–∞–∫—Ä—ã—Ç—å" class="close"
               onclick="document.getElementById('add-dialog').close()"></a>
        </header>
        <form th:action="@{/admin/analysis/add}" method="post" id="add-form">
            <table role="grid">
                <thead>
                <tr>
                    <th>#</th>
                    <th>–¢–∏–∫–µ—Ä</th>
                    <th>–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="stock, iterStat : ${availableStocks}">
                    <td th:text="${iterStat.count}">1</td>
                    <td th:text="${stock.secid}">TICK</td>
                    <td th:text="${stock.shortname}">–ù–∞–∑–≤–∞–Ω–∏–µ</td>
                    <td>
                        <label>
                            <input type="radio" name="secid"
                                   th:value="${stock.secid}"
                                   th:checked="${stock.secid == defaultSelection}">
                            <span>–í—ã–±—Ä–∞—Ç—å</span>
                        </label>
                    </td>
                </tr>
                </tbody>
            </table>
            <footer class="info-row">
                <div class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—É—é –±—É–º–∞–≥—É –∏ –Ω–∞–∂–º–∏—Ç–µ Enter. Esc –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ.</div>
                <div class="actions">
                    <button type="button" class="secondary outline"
                            onclick="document.getElementById('add-dialog').close()">–û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </footer>
        </form>
    </article>
</dialog>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ —Å –∏—Å—Ç–æ—Ä–∏–µ–π -->
<dialog id="expert-assessment-dialog">
    <article style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <header>
            <h3>–≠–∫—Å–ø–µ—Ä—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ - –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h3>
        </header>
        
        <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ -->
        <form id="expert-assessment-form" method="post" th:action="@{/admin/analysis/expert-assessment}">
            <input type="hidden" name="analysisId" id="expert-assessment-analysis-id">
            
            <table style="width: 100%; margin-bottom: 1rem; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: rgba(255, 255, 255, 0.1);">
                        <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞</th>
                        <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</th>
                        <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–î–∞—Ç–∞ –æ—Ü–µ–Ω–∫–∏</th>
                        <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                        <th style="padding: 0.5rem; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞) -->
                    <tr style="background-color: rgba(59, 130, 246, 0.15);">
                        <td style="padding: 0.5rem;">
                            <input type="number" 
                                   name="expertTarget" 
                                   id="expert-assessment-target"
                                   step="0.01"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É"
                                   style="width: 100%; padding: 0.4rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #e2e8f0; border-radius: 4px;">
                        </td>
                        <td style="padding: 0.5rem;">
                            <select name="expertRecommendation" id="expert-assessment-recommendation" style="width: 100%; padding: 0.4rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #e2e8f0; border-radius: 4px;">
                                <option value="">‚Äî</option>
                                <option value="–ü–æ–∫—É–ø–∞—Ç—å">–ü–æ–∫—É–ø–∞—Ç—å</option>
                                <option value="–î–µ—Ä–∂–∞—Ç—å">–î–µ—Ä–∂–∞—Ç—å</option>
                                <option value="–ü—Ä–æ–¥–∞–≤–∞—Ç—å">–ü—Ä–æ–¥–∞–≤–∞—Ç—å</option>
                            </select>
                        </td>
                        <td style="padding: 0.5rem;">
                            <input type="date" 
                                   name="expertTargetDate" 
                                   id="expert-assessment-date"
                                   required
                                   style="width: 100%; padding: 0.4rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #e2e8f0; border-radius: 4px;">
                        </td>
                        <td style="padding: 0.5rem; color: #94a3b8; font-size: 0.9em;">
                            <em>–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</em>
                        </td>
                        <td style="padding: 0.5rem; text-align: center;">
                            <button type="submit" style="padding: 0.4rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">–î–æ–±–∞–≤–∏—Ç—å</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <!-- –ò—Å—Ç–æ—Ä–∏—è (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript) -->
            <div style="margin-top: 1rem;">
                <h4 style="margin-bottom: 0.5rem;">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: rgba(255, 255, 255, 0.05);">
                            <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞</th>
                            <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</th>
                            <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–î–∞—Ç–∞ –æ—Ü–µ–Ω–∫–∏</th>
                            <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                            <th style="padding: 0.5rem; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="expert-assessment-history">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 1rem; color: #94a3b8;">
                                –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            </table>
            
            <footer class="info-row">
                <div class="muted">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –∏ –Ω–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏</div>
                <div class="actions">
                    <button type="button" class="secondary outline" onclick="closeExpertAssessmentDialog()">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </footer>
        </form>
    </article>
</dialog>

<script>
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ (–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ)
    function openExpertAssessmentDialog(analysisId, field, currentValue, priceDecimals) {
        console.log('openExpertAssessmentDialog –≤—ã–∑–≤–∞–Ω–∞:', { analysisId, field, currentValue, priceDecimals });
        const dialog = document.getElementById('expert-assessment-dialog');
        const form = document.getElementById('expert-assessment-form');
        const analysisIdInput = document.getElementById('expert-assessment-analysis-id');
        const targetInput = document.getElementById('expert-assessment-target');
        const recommendationSelect = document.getElementById('expert-assessment-recommendation');
        const dateInput = document.getElementById('expert-assessment-date');
        const historyTbody = document.getElementById('expert-assessment-history');
        
        if (!dialog) {
            console.error('–î–∏–∞–ª–æ–≥ expert-assessment-dialog –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        if (!form || !analysisIdInput) {
            console.error('–≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            return;
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID –∞–Ω–∞–ª–∏–∑–∞
        analysisIdInput.value = analysisId;
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º step –¥–ª—è –ø–æ–ª—è "–¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞" –Ω–∞ –æ—Å–Ω–æ–≤–µ decimals
        if (targetInput && priceDecimals != null) {
            const decimals = parseInt(priceDecimals, 10) || 2;
            let step = '0.01';
            if (decimals <= 0) {
                step = '1';
            } else {
                step = '0.' + '0'.repeat(decimals - 1) + '1';
            }
            targetInput.step = step;
            targetInput.setAttribute('data-price-decimals', decimals);
        }
        
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        if (targetInput) targetInput.value = '';
        if (recommendationSelect) recommendationSelect.value = '';
        if (dateInput) {
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        if (historyTbody) {
            loadExpertAssessmentHistory(analysisId, historyTbody, priceDecimals);
        }
        
        // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –Ω—É–∂–Ω–æ–º –ø–æ–ª–µ
        setTimeout(() => {
            if (field === 'expertTarget' && targetInput) {
                targetInput.focus();
            } else if (field === 'expertRecommendation' && recommendationSelect) {
                recommendationSelect.focus();
            }
        }, 100);
        
        dialog.showModal();
        console.log('–î–∏–∞–ª–æ–≥ –æ—Ç–∫—Ä—ã—Ç');
    }

    async function loadExpertAssessmentHistory(analysisId, tbody, priceDecimals) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 1rem; color: #94a3b8;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
        
        try {
            const response = await fetch(`/admin/analysis/expert-assessment/${analysisId}/history`);
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ' + response.status);
            }
            const history = await response.json();
            
            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 1rem; color: #94a3b8;">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</td></tr>';
                return;
            }
            
            const decimals = priceDecimals != null ? parseInt(priceDecimals, 10) || 2 : 2;
            
            tbody.innerHTML = history.map(item => {
                const createdAt = item.createdAt ? new Date(item.createdAt).toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '‚Äî';
                const targetDate = item.expertTargetDate ? new Date(item.expertTargetDate + 'T00:00:00').toLocaleDateString('ru-RU') : '‚Äî';
                const recommendationClass = item.expertRecommendation === '–ü–æ–∫—É–ø–∞—Ç—å' ? 'recommendation-buy' :
                                          item.expertRecommendation === '–î–µ—Ä–∂–∞—Ç—å' ? 'recommendation-hold' :
                                          item.expertRecommendation === '–ü—Ä–æ–¥–∞–≤–∞—Ç—å' ? 'recommendation-sell' : '';
                const targetValue = item.expertTarget ? parseFloat(item.expertTarget).toLocaleString('ru-RU', {
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                }) : '‚Äî';
                
                return `
                    <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);" data-assessment-id="${item.id}">
                        <td style="padding: 0.5rem;">
                            <input type="number" 
                                   class="edit-target-input" 
                                   data-assessment-id="${item.id}"
                                   value="${item.expertTarget || ''}"
                                   step="${decimals <= 0 ? '1' : '0.' + '0'.repeat(decimals - 1) + '1'}"
                                   style="width: 100%; padding: 0.3rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); color: #e2e8f0; border-radius: 4px; display: none;">
                            <span class="target-display">${targetValue}</span>
                        </td>
                        <td style="padding: 0.5rem;">
                            <select class="edit-recommendation-select" 
                                    data-assessment-id="${item.id}"
                                    style="width: 100%; padding: 0.3rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); color: #e2e8f0; border-radius: 4px; display: none;">
                                <option value="">‚Äî</option>
                                <option value="–ü–æ–∫—É–ø–∞—Ç—å" ${item.expertRecommendation === '–ü–æ–∫—É–ø–∞—Ç—å' ? 'selected' : ''}>–ü–æ–∫—É–ø–∞—Ç—å</option>
                                <option value="–î–µ—Ä–∂–∞—Ç—å" ${item.expertRecommendation === '–î–µ—Ä–∂–∞—Ç—å' ? 'selected' : ''}>–î–µ—Ä–∂–∞—Ç—å</option>
                                <option value="–ü—Ä–æ–¥–∞–≤–∞—Ç—å" ${item.expertRecommendation === '–ü—Ä–æ–¥–∞–≤–∞—Ç—å' ? 'selected' : ''}>–ü—Ä–æ–¥–∞–≤–∞—Ç—å</option>
                            </select>
                            <span class="recommendation-display ${recommendationClass}">${item.expertRecommendation || '‚Äî'}</span>
                        </td>
                        <td style="padding: 0.5rem;">
                            <input type="date" 
                                   class="edit-date-input" 
                                   data-assessment-id="${item.id}"
                                   value="${item.expertTargetDate || ''}"
                                   style="width: 100%; padding: 0.3rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); color: #e2e8f0; border-radius: 4px; display: none;">
                            <span class="date-display">${targetDate}</span>
                        </td>
                        <td style="padding: 0.5rem; color: #94a3b8; font-size: 0.9em;">${createdAt}</td>
                        <td style="padding: 0.5rem; text-align: center;">
                            <button type="button" 
                                    class="edit-assessment-btn" 
                                    data-assessment-id="${item.id}"
                                    style="padding: 0.3rem 0.6rem; margin-right: 0.3rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button type="button" 
                                    class="save-assessment-btn" 
                                    data-assessment-id="${item.id}"
                                    style="padding: 0.3rem 0.6rem; margin-right: 0.3rem; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; display: none;">
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                            <button type="button" 
                                    class="cancel-edit-btn" 
                                    data-assessment-id="${item.id}"
                                    style="padding: 0.3rem 0.6rem; margin-right: 0.3rem; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; display: none;">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                            <button type="button" 
                                    class="delete-assessment-btn" 
                                    data-assessment-id="${item.id}"
                                    style="padding: 0.3rem 0.6rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
            attachHistoryEventHandlers();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 1rem; color: #ef4444;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ' + error.message + '</td></tr>';
        }
    }
    
    function attachHistoryEventHandlers() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        document.querySelectorAll('.edit-assessment-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const assessmentId = this.dataset.assessmentId;
                const row = this.closest('tr');
                enableEditMode(row, assessmentId);
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        document.querySelectorAll('.save-assessment-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const assessmentId = this.dataset.assessmentId;
                await saveAssessmentEdit(assessmentId);
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –æ—Ç–º–µ–Ω—ã
        document.querySelectorAll('.cancel-edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const assessmentId = this.dataset.assessmentId;
                const row = this.closest('tr');
                cancelEditMode(row, assessmentId);
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
        document.querySelectorAll('.delete-assessment-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const assessmentId = this.dataset.assessmentId;
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
                    await deleteAssessment(assessmentId);
                }
            });
        });
    }
    
    function enableEditMode(row, assessmentId) {
        // –°–∫—Ä—ã–≤–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
        row.querySelector('.target-display').style.display = 'none';
        row.querySelector('.edit-target-input').style.display = 'block';
        row.querySelector('.recommendation-display').style.display = 'none';
        row.querySelector('.edit-recommendation-select').style.display = 'block';
        row.querySelector('.date-display').style.display = 'none';
        row.querySelector('.edit-date-input').style.display = 'block';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –æ—Ç–º–µ–Ω—ã, —Å–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ
        row.querySelector('.edit-assessment-btn').style.display = 'none';
        row.querySelector('.delete-assessment-btn').style.display = 'none';
        row.querySelector('.save-assessment-btn').style.display = 'inline-block';
        row.querySelector('.cancel-edit-btn').style.display = 'inline-block';
    }
    
    function cancelEditMode(row, assessmentId) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
        row.querySelector('.target-display').style.display = 'inline';
        row.querySelector('.edit-target-input').style.display = 'none';
        row.querySelector('.recommendation-display').style.display = 'inline';
        row.querySelector('.edit-recommendation-select').style.display = 'none';
        row.querySelector('.date-display').style.display = 'inline';
        row.querySelector('.edit-date-input').style.display = 'none';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è, —Å–∫—Ä—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –æ—Ç–º–µ–Ω—É
        row.querySelector('.edit-assessment-btn').style.display = 'inline-block';
        row.querySelector('.delete-assessment-btn').style.display = 'inline-block';
        row.querySelector('.save-assessment-btn').style.display = 'none';
        row.querySelector('.cancel-edit-btn').style.display = 'none';
    }
    
    async function saveAssessmentEdit(assessmentId) {
        const row = document.querySelector(`tr[data-assessment-id="${assessmentId}"]`);
        if (!row) {
            alert('–°—Ç—Ä–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            return;
        }
        
        const targetInput = row.querySelector('.edit-target-input');
        const recommendationSelect = row.querySelector('.edit-recommendation-select');
        const dateInput = row.querySelector('.edit-date-input');
        
        const expertTarget = targetInput.value.trim() || null;
        const expertRecommendation = recommendationSelect.value || null;
        const expertTargetDate = dateInput.value || null;
        
        try {
            const params = new URLSearchParams();
            if (expertTarget) params.append('expertTarget', expertTarget);
            if (expertRecommendation) params.append('expertRecommendation', expertRecommendation);
            if (expertTargetDate) params.append('expertTargetDate', expertTargetDate);
            
            const response = await fetch(`/admin/analysis/expert-assessment/${assessmentId}?${params.toString()}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
            }
            
            const result = await response.json();
            if (result.success) {
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
                const analysisIdInput = document.getElementById('expert-assessment-analysis-id');
                const historyTbody = document.getElementById('expert-assessment-history');
                const targetInputMain = document.getElementById('expert-assessment-target');
                const priceDecimals = targetInputMain ? targetInputMain.getAttribute('data-price-decimals') : null;
                await loadExpertAssessmentHistory(analysisIdInput.value, historyTbody, priceDecimals);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
                refreshTable();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è'));
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message);
        }
    }
    
    async function deleteAssessment(assessmentId) {
        try {
            const response = await fetch(`/admin/analysis/expert-assessment/${assessmentId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
            }
            
            const result = await response.json();
            if (result.success) {
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
                const analysisIdInput = document.getElementById('expert-assessment-analysis-id');
                const historyTbody = document.getElementById('expert-assessment-history');
                const targetInputMain = document.getElementById('expert-assessment-target');
                const priceDecimals = targetInputMain ? targetInputMain.getAttribute('data-price-decimals') : null;
                await loadExpertAssessmentHistory(analysisIdInput.value, historyTbody, priceDecimals);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
                refreshTable();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å'));
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message);
        }
    }

    function closeExpertAssessmentDialog() {
        const dialog = document.getElementById('expert-assessment-dialog');
        if (dialog) {
            dialog.close();
        }
    }

    (function () {
        const expertFieldClickables = document.querySelectorAll('.expert-field-clickable');
        const addForm = document.getElementById('add-form');
        const dialog = document.getElementById('add-dialog');
        const addButton = document.getElementById('add-button');
        const shouldOpenDialog = document.body.dataset.openDialog === 'true';
        const newlyAddedSecid = document.body.dataset.newlyAddedSecid;

        if (addButton && dialog) {
            addButton.addEventListener('click', () => {
                console.debug('Opening add-dialog. options=%d', dialog.querySelectorAll('tbody tr').length);
                dialog.showModal();
            });
        }

        if (dialog) {
            if (shouldOpenDialog && !dialog.open) {
                console.debug('Auto-opening add-dialog');
                dialog.showModal();
            }
            dialog.addEventListener('close', () => console.debug('Add-dialog closed'));
            dialog.addEventListener('cancel', () => console.debug('Add-dialog cancelled'));
        }


        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –Ω–∞ –ø–æ–ª—è —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫–∏
        console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã—Ö –ø–æ–ª–µ–π. –ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤:', expertFieldClickables.length);
        if (expertFieldClickables.length === 0) {
            console.warn('–ù–µ –Ω–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å –∫–ª–∞—Å—Å–æ–º expert-field-clickable. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ HTML —Ä–∞–∑–º–µ—Ç–∫—É.');
        }
        expertFieldClickables.forEach((element, index) => {
            console.log(`–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞ ${index}:`, {
                analysisId: element.dataset.analysisId,
                field: element.dataset.field,
                text: element.textContent.trim(),
                element: element
            });
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –∫–ª–∏–∫–∞–±–µ–ª–µ–Ω
            element.style.cursor = 'pointer';
            element.style.textDecoration = 'underline';
            if (!element.style.color || element.style.color === '') {
                element.style.color = '#3b82f6';
            }
            
            element.addEventListener('click', (event) => {
                event.preventDefault();
                event.stopPropagation();
                const analysisId = element.dataset.analysisId;
                const field = element.dataset.field;
                const currentValue = element.textContent.trim();
                const priceDecimals = element.dataset.priceDecimals || '2';
                console.log('–ö–ª–∏–∫ –Ω–∞ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–µ –ø–æ–ª–µ:', { analysisId, field, currentValue, priceDecimals });
                if (typeof openExpertAssessmentDialog === 'function') {
                    openExpertAssessmentDialog(analysisId, field, currentValue, priceDecimals);
                } else {
                    console.error('–§—É–Ω–∫—Ü–∏—è openExpertAssessmentDialog –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞!');
                    alert('–û—à–∏–±–∫–∞: —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–∏–∞–ª–æ–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.');
                }
            });
        });


        if (addForm) {
            const radioInputs = addForm.querySelectorAll('input[name="secid"]');
            radioInputs.forEach(input => {
                input.addEventListener('keydown', event => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        addForm.requestSubmit();
                    }
                });
                input.addEventListener('dblclick', () => addForm.requestSubmit());
            });
        }

        const tableContainer = document.querySelector('.table-container');

        if (tableContainer) {
            tableContainer.addEventListener('wheel', event => {
                const {scrollTop, scrollHeight, clientHeight} = tableContainer;
                const atTop = scrollTop === 0 && event.deltaY < 0;
                const atBottom = Math.ceil(scrollTop + clientHeight) >= scrollHeight && event.deltaY > 0;
                if (!(atTop || atBottom)) {
                    event.preventDefault();
                    tableContainer.scrollTop += event.deltaY;
                }
            }, {passive: false});
        }

        // –ï—Å–ª–∏ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∞–∫—Ü–∏—è, –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–µ–π
        if (newlyAddedSecid) {
            setTimeout(() => {
                const row = document.querySelector('tr[data-secid="' + newlyAddedSecid + '"]');
                if (row) {
                    scrollIntoViewIfNeeded(row);
                }
            }, 100);
        } else {
            restoreScrollPosition();
        }
        console.debug('analysis page init: rows=%d, addButton=%s, shouldOpenDialog=%s, newlyAddedSecid=%s',
            document.querySelectorAll('tr[data-analysis-id]').length,
            !!addButton,
            shouldOpenDialog,
            newlyAddedSecid || 'none');

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        const refreshButton = document.getElementById('refresh-button');
        if (refreshButton) {
            refreshButton.addEventListener('click', refreshTable);
        }
    })();

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–ª–∞
    function formatDecimal(value, decimals) {
        if (!value) return '‚Äî';
        const num = parseFloat(value);
        if (isNaN(num)) return '‚Äî';
        return num.toFixed(decimals);
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —á–µ—Ä–µ–∑ AJAX
    function refreshTable() {
        const refreshButton = document.getElementById('refresh-button');
        if (refreshButton) {
            refreshButton.disabled = true;
            refreshButton.textContent = '‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∏ —Ñ–æ–∫—É—Å
        const tableContainer = document.querySelector('.table-container');
        const scrollTop = tableContainer ? tableContainer.scrollTop : 0;
        const activeElement = document.activeElement;
        let activeField = null;
        let activeId = null;
        
        if (activeElement && activeElement.tagName === 'INPUT') {
            activeField = activeElement.dataset.field;
            activeId = activeElement.dataset.analysisId;
        } else if (activeElement && activeElement.tagName === 'SELECT') {
            activeField = 'recommendation';
            const name = activeElement.name;
            const match = name.match(/expertRecommendation\[(\d+)\]/);
            if (match) {
                activeId = match[1];
            }
        }
        
        // API endpoint –¥–ª—è admin-stock-analysis –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—É—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.location.reload();
        return;
        /* fetch('/admin/analysis/api/rows')
            .then(response => {
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö');
                }
                return response.json();
            })
            .then(data => {
                const tbody = document.querySelector('#analysis-form tbody');
                if (!tbody || !data.rows) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
                data.rows.forEach((rowData) => {
                    const row = tbody.querySelector(`tr[data-analysis-id="${rowData.analysisId}"]`);
                    if (!row) return;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 8) {
                        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ –¥–ª—è —Ü–µ–Ω—ã
                        const priceDecimals = rowData.priceDecimals != null ? parseInt(rowData.priceDecimals, 10) : 2;
                        
                        // –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ (–∏–Ω–¥–µ–∫—Å 3)
                        cells[3].textContent = rowData.marketPrice ? formatDecimal(rowData.marketPrice, priceDecimals) : '‚Äî';
                        // –û–±–Ω–æ–≤–ª—è–µ–º data-–∞—Ç—Ä–∏–±—É—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ decimals
                        cells[3].setAttribute('data-price-decimals', priceDecimals);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Å–ø–µ—Ä—Ç–Ω—É—é –æ—Ü–µ–Ω–∫—É (–∏–Ω–¥–µ–∫—Å 4 - "–û—Ü–µ–Ω–∫–∞ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤")
                        if (cells.length > 4) {
                            const expertTargetSpan = cells[4].querySelector('.expert-field-clickable');
                            if (expertTargetSpan) {
                                expertTargetSpan.textContent = rowData.expertTarget && rowData.expertTarget !== '‚Äî' ? rowData.expertTarget : '‚Äî';
                            }
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ (–∏–Ω–¥–µ–∫—Å 5)
                        if (cells.length > 5 && rowData.expertTargetDate) {
                            const date = new Date(rowData.expertTargetDate + 'T00:00:00');
                            cells[5].textContent = date.toLocaleDateString('ru-RU', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                            });
                        } else if (cells.length > 5) {
                            cells[5].textContent = '‚Äî';
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é (–∏–Ω–¥–µ–∫—Å 6)
                        if (cells.length > 6) {
                            const recommendationSpan = cells[6].querySelector('.expert-field-clickable');
                            if (recommendationSpan) {
                                recommendationSpan.textContent = rowData.expertRecommendation || '‚Äî';
                                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Ü–≤–µ—Ç–∞
                                recommendationSpan.className = 'expert-field-clickable';
                                if (rowData.expertRecommendation === '–ü–æ–∫—É–ø–∞—Ç—å') {
                                    recommendationSpan.classList.add('recommendation-buy');
                                } else if (rowData.expertRecommendation === '–î–µ—Ä–∂–∞—Ç—å') {
                                    recommendationSpan.classList.add('recommendation-hold');
                                } else if (rowData.expertRecommendation === '–ü—Ä–æ–¥–∞–≤–∞—Ç—å') {
                                    recommendationSpan.classList.add('recommendation-sell');
                                }
                            }
                        }
                        
                        // –ü—Ä–æ–≥–Ω–æ–∑ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ (–∏–Ω–¥–µ–∫—Å 7)
                        if (cells.length > 7) {
                            cells[7].textContent = rowData.expertForecastPercent ? formatDecimal(rowData.expertForecastPercent, 2) : '‚Äî';
                        }
                    }
                });
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                if (tableContainer) {
                    tableContainer.scrollTop = scrollTop;
                }
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è stock_analysis (–Ω–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö –ø–æ–ª–µ–π)
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            })
            .finally(() => {
                if (refreshButton) {
                    refreshButton.disabled = false;
                    refreshButton.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å';
                }
            }); */
    }

    function submitDelete(button) {
        const id = button.getAttribute('data-delete-id');
        const deleteForm = document.getElementById('delete-form');
        const input = document.getElementById('delete-id');
        input.value = id;
        deleteForm.submit();
    }



    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫–∏
    (function() {
        const expertAssessmentForm = document.getElementById('expert-assessment-form');
        if (expertAssessmentForm) {
            expertAssessmentForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                
                const formData = new FormData(expertAssessmentForm);
                const submitButton = expertAssessmentForm.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                submitButton.disabled = true;
                submitButton.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                
                try {
                    const response = await fetch(expertAssessmentForm.action, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏ –æ—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                        const analysisId = document.getElementById('expert-assessment-analysis-id').value;
                        const historyTbody = document.getElementById('expert-assessment-history');
                        if (historyTbody) {
                            const targetInputMain = document.getElementById('expert-assessment-target');
                            const priceDecimals = targetInputMain ? targetInputMain.getAttribute('data-price-decimals') : null;
                            await loadExpertAssessmentHistory(analysisId, historyTbody, priceDecimals);
                        }
                        
                        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                        const form = document.getElementById('expert-assessment-form');
                        if (form) {
                            form.reset();
                            const dateInput = document.getElementById('expert-assessment-date');
                            if (dateInput) {
                                const today = new Date().toISOString().split('T')[0];
                                dateInput.value = today;
                            }
                            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º analysisId –ø–æ—Å–ª–µ reset
                            document.getElementById('expert-assessment-analysis-id').value = analysisId;
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —ç–∫—Å–ø–µ—Ä—Ç–Ω—É—é –æ—Ü–µ–Ω–∫—É)
                        refreshTable();
                        
                        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + (result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫—É'));
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫–∏:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message);
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            });
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –¥–∏–∞–ª–æ–≥–∞ –ø–æ Escape
        const expertDialog = document.getElementById('expert-assessment-dialog');
        if (expertDialog) {
            expertDialog.addEventListener('cancel', function(event) {
                event.preventDefault();
                closeExpertAssessmentDialog();
            });
        }
    })();

    function queueFocus(target) {
        try {
            sessionStorage.setItem('analysisFocus', JSON.stringify(target));
        } catch (err) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ–∫—É—Å', err);
        }
    }

    function saveScrollPosition() {
        const tableContainer = document.querySelector('.table-container');
        if (tableContainer) {
            try {
                sessionStorage.setItem('analysisScrollTop', String(tableContainer.scrollTop));
            } catch (err) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏', err);
            }
        }
    }

    function restoreScrollPosition() {
        const tableContainer = document.querySelector('.table-container');
        if (!tableContainer) {
            return;
        }
        try {
            const stored = sessionStorage.getItem('analysisScrollTop');
            if (stored) {
                sessionStorage.removeItem('analysisScrollTop');
                const scrollTop = parseInt(stored, 10);
                if (!isNaN(scrollTop)) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
                    requestAnimationFrame(() => {
                        tableContainer.scrollTop = scrollTop;
                    });
                }
            }
        } catch (err) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏', err);
        }
    }

    function scrollIntoViewIfNeeded(element) {
        if (!element) {
            return;
        }
        const tableContainer = document.querySelector('.table-container');
        if (!tableContainer) {
            return;
        }
        const containerRect = tableContainer.getBoundingClientRect();
        const elementRect = element.getBoundingClientRect();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∏–¥–µ–Ω –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
        const isVisible = elementRect.top >= containerRect.top && 
                         elementRect.bottom <= containerRect.bottom;
        
        if (!isVisible) {
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã —ç–ª–µ–º–µ–Ω—Ç –±—ã–ª –≤ —Ü–µ–Ω—Ç—Ä–µ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
            const row = element.closest('tr');
            if (row) {
                const rowOffset = row.offsetTop;
                const containerHeight = tableContainer.clientHeight;
                const rowHeight = row.offsetHeight;
                tableContainer.scrollTop = rowOffset - (containerHeight / 2) + (rowHeight / 2);
            }
        }
    }

    function sortTable(sortBy, sortDir) {
        const url = new URL(window.location.href);
        url.searchParams.set('sortBy', sortBy);
        url.searchParams.set('sortDir', sortDir);
        window.location.href = url.toString();
    }

    function restoreFocus() {
        const stored = sessionStorage.getItem('analysisFocus');
        if (!stored) {
            return;
        }
        sessionStorage.removeItem('analysisFocus');
        try {
            const target = JSON.parse(stored);
            if (!target || !target.field) {
                return;
            }
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏, —á—Ç–æ–±—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —É—Å–ø–µ–ª–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
            setTimeout(() => {
                if (target.field === 'addButton') {
                    const addButton = document.getElementById('add-button');
                    if (addButton) {
                        addButton.focus();
                    }
                    return;
                }
                if (target.field === 'recommendation' && target.id) {
                    const select = document.querySelector('select[name="expertRecommendation[' + target.id + ']"]');
                    if (select) {
                        scrollIntoViewIfNeeded(select);
                        select.focus();
                    }
                    return;
                }
                // –î–ª—è stock_analysis –Ω–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö –ø–æ–ª–µ–π, —Ç–æ–ª—å–∫–æ —ç–∫—Å–ø–µ—Ä—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            }, 50);
        } catch (err) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–æ–∫—É—Å', err);
        }
    }
</script>
</body>
</html>


