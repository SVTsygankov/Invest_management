# Интеграция с ALOR БРОКЕР API

## Обзор

Система поддерживает интеграцию с ALOR OpenAPI для автоматической загрузки данных о сделках, позициях и движениях денежных средств из брокерских счетов.

## Безопасное хранение токенов

### Шифрование

Refresh Tokens хранятся в базе данных в зашифрованном виде с использованием AES256 шифрования через Spring Security Crypto.

### Настройка ключей шифрования

**ВАЖНО:** Никогда не храните ключи шифрования в открытом виде в репозитории!

1. **Генерация ключей:**
   ```bash
   # Генерация пароля (32 байта)
   openssl rand -base64 32
   
   # Генерация соли (16 байт)
   openssl rand -base64 16
   ```

2. **Настройка через переменные окружения:**
   ```bash
   export ALOR_ENCRYPTION_PASSWORD="<сгенерированный пароль>"
   export ALOR_ENCRYPTION_SALT="<сгенерированная соль>"
   ```

3. **Настройка в application.properties:**
   ```properties
   alor.api.encryption.password=${ALOR_ENCRYPTION_PASSWORD}
   alor.api.encryption.salt=${ALOR_ENCRYPTION_SALT}
   ```

### Процесс сохранения токена

1. Пользователь вводит Refresh Token через UI
2. `AlorTokenService.encrypt()` шифрует токен с использованием AES256
3. Зашифрованный токен сохраняется в БД в таблице `alor_user_tokens`
4. При использовании токен расшифровывается через `AlorTokenService.decrypt()`

### Безопасность на уровне БД

- Токены хранятся в зашифрованном виде (Base64-encoded encrypted bytes)
- Каждый пользователь имеет отдельный токен для тестового и боевого контуров
- Токены связаны с пользователем через внешний ключ с каскадным удалением

## Получение токенов

### Тестовый контур

1. Зарегистрируйтесь на [alor.dev](https://alor.dev)
2. Создайте учетную запись разработчика
3. Получите Refresh Token для тестового контура
4. Сохраните токен в системе через UI (будет автоматически зашифрован)

### Боевой контур

1. Войдите в личный кабинет на [alor.dev](https://alor.dev)
2. Перейдите на страницу "Токены для доступа к API"
3. Введите логин и пароль от реального торгового аккаунта
4. Нажмите "Привязать"
5. Выпишите новый Refresh Token для боевого контура
6. Сохраните токен в системе через UI

**ВАЖНО:** При работе с боевым контуром вы взаимодействуете с реальными данными и совершаете настоящие сделки!

## Использование

### Для администраторов

Администраторы могут использовать оба контура:
- **Тестовый контур** - для разработки и тестирования новых функций
- **Боевой контур** - для работы с реальными данными

### Для обычных пользователей

Обычные пользователи работают только с боевым контуром для доступа к реальным данным своего брокерского счета.

## Структура данных

### Таблица `alor_user_tokens`

- `id` - уникальный идентификатор
- `user_id` - ссылка на пользователя
- `environment` - окружение ("test" или "production")
- `encrypted_refresh_token` - зашифрованный Refresh Token
- `trade_server_code` - код торгового сервера (MOEX, SPBX и т.д.)
- `portfolio_id` - опциональная ссылка на портфель
- `created_at`, `updated_at` - временные метки

### Уникальный индекс

Один токен на пользователя для каждого окружения: `(user_id, environment)`

## API Endpoints (требуют уточнения)

Следующие endpoints необходимо уточнить в документации ALOR OpenAPI:

1. **Получение Access Token:**
   - Текущий: `/refresh`
   - Возможные варианты: `/oauth2/token`, `/v2/refresh`
   - Документация: https://alor.dev/docs/api/access/authorization/refresh-token

2. **Получение сделок:**
   - Текущий: `/commandapi/warptrans/TRADE/v2/client/{portfolioId}/orders`
   - Документация: https://alor.dev/docs/api/trades

3. **Получение позиций:**
   - Текущий: `/commandapi/warptrans/TRADE/v2/client/{portfolioId}/summary`
   - Документация: https://alor.dev/docs/api/positions

4. **Получение движений денежных средств:**
   - Текущий: `/commandapi/warptrans/TRADE/v2/client/{portfolioId}/money`
   - Документация: https://alor.dev/docs/api/cash-movements

## Следующие шаги

1. Уточнить актуальные endpoints в документации ALOR OpenAPI
2. Реализовать маппинг данных из ALOR API в формат `BrokerReportParser.ParsedReport`
3. Интегрировать в `BrokerReportService` для автоматической загрузки данных
4. Добавить UI для управления токенами (сохранение, обновление, удаление)
5. Реализовать автоматическую синхронизацию данных по расписанию

## Полезные ссылки

- [ALOR OpenAPI Документация](https://alor.dev/docs/)
- [Быстрый старт](https://alor.dev/docs/api/quick-start/dev-env)
- [Авторизация](https://alor.dev/docs/api/access/authorization/trade-account)
- [Telegram поддержка](https://t.me/alor_openapi)

