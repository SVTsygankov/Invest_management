databaseChangeLog:
  - changeSet:
      id: 009-create-portfolio-tables
      author: cursor-agent
      changes:
        - createTable:
            tableName: portfolios
            remarks: "User portfolios"
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: broker_account
                  type: VARCHAR(50)
                  remarks: "Номер договора с брокером"
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: portfolios
            baseColumnNames: user_id
            constraintName: fk_portfolios_user
            referencedTableName: users
            referencedColumnNames: id
            onDelete: CASCADE
        - createTable:
            tableName: portfolio_positions
            remarks: "Current portfolio positions (computed from transactions)"
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: portfolio_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: isin
                  type: VARCHAR(12)
                  constraints:
                    nullable: false
              - column:
                  name: security_type
                  type: VARCHAR(10)
                  remarks: "STOCK or BOND"
              - column:
                  name: currency
                  type: VARCHAR(10)
              - column:
                  name: quantity
                  type: NUMERIC(18,4)
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: portfolio_positions
            baseColumnNames: portfolio_id
            constraintName: fk_portfolio_positions_portfolio
            referencedTableName: portfolios
            referencedColumnNames: id
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: portfolio_positions
            columnNames: portfolio_id, isin
            constraintName: uq_portfolio_positions_portfolio_isin
        - createIndex:
            tableName: portfolio_positions
            indexName: idx_portfolio_positions_isin
            columns:
              - column:
                  name: isin
        - createTable:
            tableName: portfolio_transactions
            remarks: "Portfolio transactions (trades)"
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: portfolio_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: isin
                  type: VARCHAR(12)
                  constraints:
                    nullable: false
              - column:
                  name: security_type
                  type: VARCHAR(10)
                  remarks: "STOCK or BOND"
              - column:
                  name: trade_date
                  type: DATE
                  constraints:
                    nullable: false
              - column:
                  name: settlement_date
                  type: DATE
              - column:
                  name: trade_time
                  type: TIME
              - column:
                  name: currency
                  type: VARCHAR(10)
                  constraints:
                    nullable: false
              - column:
                  name: operation_type
                  type: VARCHAR(20)
                  constraints:
                    nullable: false
                  remarks: "Покупка or Продажа"
              - column:
                  name: quantity
                  type: NUMERIC(18,4)
                  constraints:
                    nullable: false
              - column:
                  name: price
                  type: NUMERIC(18,6)
                  constraints:
                    nullable: false
              - column:
                  name: amount
                  type: NUMERIC(18,2)
                  constraints:
                    nullable: false
              - column:
                  name: accrued_interest
                  type: NUMERIC(18,2)
                  remarks: "НКД для облигаций"
              - column:
                  name: broker_commission
                  type: NUMERIC(18,2)
              - column:
                  name: exchange_commission
                  type: NUMERIC(18,2)
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
        - addForeignKeyConstraint:
            baseTableName: portfolio_transactions
            baseColumnNames: portfolio_id
            constraintName: fk_portfolio_transactions_portfolio
            referencedTableName: portfolios
            referencedColumnNames: id
            onDelete: CASCADE
        - createIndex:
            tableName: portfolio_transactions
            indexName: idx_portfolio_transactions_portfolio_date
            columns:
              - column:
                  name: portfolio_id
              - column:
                  name: trade_date
        - createIndex:
            tableName: portfolio_transactions
            indexName: idx_portfolio_transactions_isin
            columns:
              - column:
                  name: isin
        - createTable:
            tableName: portfolio_cash_movements
            remarks: "Portfolio cash movements"
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: portfolio_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: date
                  type: DATE
                  constraints:
                    nullable: false
              - column:
                  name: trading_platform
                  type: VARCHAR(100)
              - column:
                  name: description
                  type: VARCHAR(500)
              - column:
                  name: currency
                  type: VARCHAR(10)
              - column:
                  name: credit_amount
                  type: NUMERIC(18,2)
                  defaultValueNumeric: 0
              - column:
                  name: debit_amount
                  type: NUMERIC(18,2)
                  defaultValueNumeric: 0
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
        - addForeignKeyConstraint:
            baseTableName: portfolio_cash_movements
            baseColumnNames: portfolio_id
            constraintName: fk_portfolio_cash_movements_portfolio
            referencedTableName: portfolios
            referencedColumnNames: id
            onDelete: CASCADE
        - createIndex:
            tableName: portfolio_cash_movements
            indexName: idx_portfolio_cash_movements_portfolio_date
            columns:
              - column:
                  name: portfolio_id
              - column:
                  name: date
        - createTable:
            tableName: broker_reports
            remarks: "Uploaded broker reports metadata"
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: portfolio_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: file_name
                  type: VARCHAR(255)
              - column:
                  name: report_period_start
                  type: DATE
                  constraints:
                    nullable: false
              - column:
                  name: report_period_end
                  type: DATE
                  constraints:
                    nullable: false
              - column:
                  name: report_created_date
                  type: DATE
              - column:
                  name: investor_name
                  type: VARCHAR(255)
              - column:
                  name: contract_number
                  type: VARCHAR(50)
              - column:
                  name: uploaded_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: uploaded_by
                  type: BIGINT
        - addForeignKeyConstraint:
            baseTableName: broker_reports
            baseColumnNames: portfolio_id
            constraintName: fk_broker_reports_portfolio
            referencedTableName: portfolios
            referencedColumnNames: id
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: broker_reports
            baseColumnNames: uploaded_by
            constraintName: fk_broker_reports_user
            referencedTableName: users
            referencedColumnNames: id
            onDelete: SET NULL
        - addUniqueConstraint:
            tableName: broker_reports
            columnNames: portfolio_id, report_period_start, report_period_end
            constraintName: uq_broker_reports_portfolio_period
        - createIndex:
            tableName: broker_reports
            indexName: idx_broker_reports_uploaded_by
            columns:
              - column:
                  name: uploaded_by

